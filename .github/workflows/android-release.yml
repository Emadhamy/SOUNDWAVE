name: ğŸš€ Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  release:
    name: ğŸ“¦ Build & Release
    runs-on: ubuntu-latest
    
    steps:
      # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. ØµÙ„Ø§Ø­ÙŠØ§Øª Gradle
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew

      # 4. Cache
      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 5. ÙÙƒ ØªØ´ÙÙŠØ± Keystore
      - name: ğŸ” Decode Keystore
        env:
          ENCODED_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo $ENCODED_KEYSTORE | base64 -d > app/keystore.jks

      # 6. Ø¨Ù†Ø§Ø¡ Release APK Ù…ÙˆÙ‚Ù‘Ø¹
      - name: ğŸ”¨ Build Signed Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$PWD/app/keystore.jks \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --stacktrace

      # 7. Ø¨Ù†Ø§Ø¡ App Bundle
      - name: ğŸ“¦ Build Release Bundle (AAB)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$PWD/app/keystore.jks \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --stacktrace

      # 8. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      # 9. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª
      - name: ğŸ“ Rename Files
        run: |
          mv app/build/outputs/apk/release/app-release.apk \
             app/build/outputs/apk/release/SoundWave-v${{ steps.version.outputs.VERSION }}.apk
          mv app/build/outputs/bundle/release/app-release.aab \
             app/build/outputs/bundle/release/SoundWave-v${{ steps.version.outputs.VERSION }}.aab

      # 10. Ø¥Ù†Ø´Ø§Ø¡ Release Ø¹Ù„Ù‰ GitHub
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: SoundWave v${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸµ SoundWave v${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            - **APK**: Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
            - **AAB**: Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Google Play
            
            ### ğŸ“‹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            - ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡
            - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            
            ---
            ğŸ“± **Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯**: 8.0 (API 26)
          files: |
            app/build/outputs/apk/release/SoundWave-v${{ steps.version.outputs.VERSION }}.apk
            app/build/outputs/bundle/release/SoundWave-v${{ steps.version.outputs.VERSION }}.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. Ø­Ø°Ù Keystore
      - name: ğŸ§¹ Clean up Keystore
        if: always()
        run: rm -f app/keystore.jks