name: ğŸš€ Build Signed APK (Auto)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-signed:
    name: ğŸ“¦ Build Signed APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. ØµÙ„Ø§Ø­ÙŠØ§Øª Gradle
      - name: ğŸ”‘ Grant execute permission
        run: chmod +x gradlew

      # 4. Cache Gradle
      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-v2-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-v2-

      # 5. Ø¥Ù†Ø´Ø§Ø¡ Keystore ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·)
      - name: ğŸ” Create Temporary Keystore
        run: |
          mkdir -p app/keystore
          keytool -genkeypair -v \
            -keystore app/keystore/temp_keystore.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 365 \
            -alias soundwave_temp \
            -storepass temp123456 \
            -keypass temp123456 \
            -dname "CN=SoundWave Test, OU=Development, O=SoundWave, L=Cairo, ST=Cairo, C=EG"

      # 6. Ø¨Ù†Ø§Ø¡ Debug APK Ù…ÙˆÙ‚Ø¹
      - name: ğŸ”¨ Build Debug APK (Signed)
        run: |
          ./gradlew assembleDebug \
            -PSOUNDWAVE_KEYSTORE_PATH=app/keystore/temp_keystore.jks \
            -PSOUNDWAVE_KEYSTORE_PASSWORD=temp123456 \
            -PSOUNDWAVE_KEY_ALIAS=soundwave_temp \
            -PSOUNDWAVE_KEY_PASSWORD=temp123456 \
            --stacktrace

      # 7. Ø¨Ù†Ø§Ø¡ Release APK Ù…ÙˆÙ‚Ø¹
      - name: ğŸ“¦ Build Release APK (Signed)
        run: |
          ./gradlew assembleRelease \
            -PSOUNDWAVE_KEYSTORE_PATH=app/keystore/temp_keystore.jks \
            -PSOUNDWAVE_KEYSTORE_PASSWORD=temp123456 \
            -PSOUNDWAVE_KEY_ALIAS=soundwave_temp \
            -PSOUNDWAVE_KEY_PASSWORD=temp123456 \
            --stacktrace

      # 8. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
      - name: âœ… Verify APK Signature
        run: |
          echo "ğŸ” Checking Debug APK signature..."
          $ANDROID_HOME/build-tools/*/apksigner verify --print-certs app/build/outputs/apk/debug/app-debug.apk || true
          echo ""
          echo "ğŸ” Checking Release APK signature..."
          $ANDROID_HOME/build-tools/*/apksigner verify --print-certs app/build/outputs/apk/release/app-release.apk || true

      # 9. Ø±ÙØ¹ Debug APK
      - name: ğŸ“¤ Upload Debug APK (Signed)
        uses: actions/upload-artifact@v4
        with:
          name: soundwave-debug-signed
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14

      # 10. Ø±ÙØ¹ Release APK
      - name: ğŸ“¤ Upload Release APK (Signed)
        uses: actions/upload-artifact@v4
        with:
          name: soundwave-release-signed
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      # 11. Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª APK
      - name: ğŸ“Š APK Info
        run: |
          echo "ğŸ“± Debug APK Size: $(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)"
          echo "ğŸ“± Release APK Size: $(du -h app/build/outputs/apk/release/app-release.apk | cut -f1)"

      # 12. Ø­Ø°Ù Keystore Ø§Ù„Ù…Ø¤Ù‚Øª
      - name: ğŸ§¹ Clean up Temporary Keystore
        if: always()
        run: rm -rf app/keystore/temp_keystore.jks
